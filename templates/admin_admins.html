{% extends 'admin_base.html' %}

{% block title %}Admin Management - UniCare Admin{% endblock %}

{% block active_page %}admin_admins{% endblock %}

{% block content %}
  <div class="px-4 sm:px-6 lg:px-8">
    <div class="sm:flex sm:items-center">
      <div class="sm:flex-auto">
        <h1 class="text-2xl font-semibold text-gray-900">Admin Management</h1>
        <p class="mt-2 text-sm text-gray-700">
          Manage administrator accounts and their permissions for the UniCare platform.
        </p>
      </div>
      <div class="mt-4 sm:mt-0 sm:ml-16 sm:flex-none">
        <button type="button" 
                id="addAdminBtn"
                class="inline-flex items-center justify-center rounded-md border border-transparent bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 sm:w-auto">
          <i class="bi bi-person-plus mr-2"></i> Add Admin
        </button>
      </div>
    </div>
    
    <!-- Stats Cards -->
    <div class="mt-8 grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4">
      <!-- Total Admins -->
      <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <div class="flex items-center justify-center h-12 w-12 rounded-md bg-blue-500 text-white">
                <i class="bi bi-shield-lock text-xl"></i>
              </div>
            </div>
            <div class="ml-5 w-0 flex-1">
              <dl>
                <dt class="text-sm font-medium text-gray-500 truncate">Total Admins</dt>
                <dd>
                  <div class="text-lg font-medium text-gray-900">{{ admins|length }}</div>
                </dd>
              </dl>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Active Sessions -->
      <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <div class="flex items-center justify-center h-12 w-12 rounded-md bg-green-500 text-white">
                <i class="bi bi-people text-xl"></i>
              </div>
            </div>
            <div class="ml-5 w-0 flex-1">
              <dl>
                <dt class="text-sm font-medium text-gray-500 truncate">Active Sessions</dt>
                <dd>
                  <div class="text-lg font-medium text-gray-900">{{ active_sessions|default(0) }}</div>
                </dd>
              </dl>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Last Activity -->
      <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <div class="flex items-center justify-center h-12 w-12 rounded-md bg-yellow-500 text-white">
                <i class="bi bi-clock-history text-xl"></i>
              </div>
            </div>
            <div class="ml-5 w-0 flex-1">
              <dl>
                <dt class="text-sm font-medium text-gray-500 truncate">Last Activity</dt>
                <dd>
                  <div class="text-lg font-medium text-gray-900">
                    {{ last_activity|default('No activity', true) }}
                  </div>
                </dd>
              </dl>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Admin Roles -->
      <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <div class="flex items-center justify-center h-12 w-12 rounded-md bg-purple-500 text-white">
                <i class="bi bi-tags text-xl"></i>
              </div>
            </div>
            <div class="ml-5 w-0 flex-1">
              <dl>
                <dt class="text-sm font-medium text-gray-500 truncate">Admin Roles</dt>
                <dd>
                  <div class="text-lg font-medium text-gray-900">{{ admin_roles|length }}</div>
                </dd>
              </dl>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Admins Table -->
    <div class="mt-8 flex flex-col">
      <div class="-my-2 -mx-4 overflow-x-auto sm:-mx-6 lg:-mx-8">
        <div class="inline-block min-w-full py-2 align-middle md:px-6 lg:px-8">
          <div class="overflow-hidden shadow ring-1 ring-black ring-opacity-5 md:rounded-lg">
            <table class="min-w-full divide-y divide-gray-300">
              <thead class="bg-gray-50">
                <tr>
                  <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-6">Admin</th>
                  <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Role</th>
                  <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Status</th>
                  <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Last Active</th>
                  <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Permissions</th>
                  <th scope="col" class="relative py-3.5 pl-3 pr-4 sm:pr-6">
                    <span class="sr-only">Actions</span>
                  </th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-200 bg-white">
                {% for admin in admins %}
                <tr class="hover:bg-gray-50">
                  <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm sm:pl-6">
                    <div class="flex items-center">
                      <div class="h-10 w-10 flex-shrink-0">
                        <div class="h-10 w-10 rounded-full bg-indigo-100 flex items-center justify-center">
                          <i class="bi bi-shield-lock text-indigo-600"></i>
                        </div>
                      </div>
                      <div class="ml-4">
                        <div class="font-medium text-gray-900">{{ admin.email }}</div>
                        <div class="text-gray-500">
                          {% if admin.is_current_user %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                              <i class="bi bi-person-fill-check mr-1"></i> You
                            </span>
                          {% else %}
                            <span class="text-gray-500 text-xs">Added {{ admin.admin_since|datetimeformat('%b %d, %Y') }}</span>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                  </td>
                  <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                      {% if admin.role == 'Super Admin' %}bg-purple-100 text-purple-800
                      {% elif admin.role == 'Content Manager' %}bg-blue-100 text-blue-800
                      {% elif admin.role == 'Support' %}bg-green-100 text-green-800
                      {% else %}bg-gray-100 text-gray-800{% end %}">
                      {{ admin.role or 'Administrator' }}
                    </span>
                  </td>
                  <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
                    {% if admin.is_active %}
                      <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">
                        <span class="w-2 h-2 mr-1.5 rounded-full bg-green-500"></span>
                        Active now
                      </span>
                    {% elif admin.last_login %}
                      <span class="text-gray-500">
                        Last seen {{ admin.last_login|timesince }}
                      </span>
                    {% else %}
                      <span class="text-gray-400">Never logged in</span>
                    {% endif %}
                  </td>
                  <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
                    {{ admin.last_login|datetimeformat('%b %d, %Y %I:%M %p') if admin.last_login else 'Never' }}
                  </td>
                  <td class="whitespace-nowrap px-3 py-4 text-sm">
                    <div class="flex flex-wrap gap-1.5">
                      {% for perm in admin.permissions %}
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium 
                          {% if perm == 'users' %}bg-green-100 text-green-800
                          {% elif perm == 'content' %}bg-blue-100 text-blue-800
                          {% elif perm == 'analytics' %}bg-yellow-100 text-yellow-800
                          {% elif perm == 'settings' %}bg-purple-100 text-purple-800
                          {% else %}bg-gray-100 text-gray-800{% end %}">
                          {{ perm|title }}
                        </span>
                      {% endfor %}
                    </div>
                  </td>
                  <td class="relative whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm font-medium sm:pr-6">
                    <div class="flex items-center justify-end space-x-2">
                      <button type="button" class="text-blue-600 hover:text-blue-900 edit-admin-btn"
                              data-admin-id="{{ admin.id }}" 
                              data-email="{{ admin.email|escapejs }}"
                              data-role="{{ admin.role|escapejs }}"
                              data-permissions='{{ admin.permissions|tojson|safe }}'>
                        <i class="bi bi-pencil-square"></i>
                        <span class="sr-only">Edit</span>
                      </button>
                      {% if not admin.is_current_user %}
                      <button type="button" class="text-red-600 hover:text-red-900"
                              data-admin-id="{{ admin.id }}"
                              onclick="confirmDelete('{{ admin.id }}', '{{ admin.email }}')">
                        <i class="bi bi-trash"></i>
                        <span class="sr-only">Delete</span>
                      </button>
                      {% endif %}
                    </div>
                  </td>
                </tr>
                {% else %}
                <tr>
                  <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">
                    No administrators found.
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            
            <!-- Pagination -->
            {% if pagination.pages > 1 %}
            <nav class="flex items-center justify-between border-t border-gray-200 bg-white px-4 py-3 sm:px-6" aria-label="Pagination">
              <div class="hidden sm:block">
                <p class="text-sm text-gray-700">
                  Showing <span class="font-medium">{{ pagination.first_item }}</span> to <span class="font-medium">{{ pagination.last_item }}</span> of <span class="font-medium">{{ pagination.total_items }}</span> results
                </p>
              </div>
              <div class="flex flex-1 justify-between sm:justify-end">
                {% if pagination.has_prev %}
                <a href="{{ url_for('admin_admins', page=pagination.prev_num) }}" class="relative inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">
                  Previous
                </a>
                {% else %}
                <span class="relative inline-flex items-center rounded-md border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-300 cursor-not-allowed">
                  Previous
                </span>
                {% endif %}
                {% if pagination.has_next %}
                <a href="{{ url_for('admin_admins', page=pagination.next_num) }}" class="relative ml-3 inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">
                  Next
                </a>
                {% else %}
                <span class="relative ml-3 inline-flex items-center rounded-md border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-300 cursor-not-allowed">
                  Next
                </span>
                {% endif %}
              </div>
            </nav>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

  <!-- Add/Edit Admin Modal -->
  <div id="adminModal" class="fixed z-10 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
      <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
      <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
      <div class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6">
        <div>
          <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100">
            <i class="bi bi-shield-lock text-blue-600 text-xl" id="modal-icon"></i>
          </div>
          <div class="mt-3 text-center sm:mt-5">
            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
              Add New Admin
            </h3>
            <div class="mt-4 space-y-4">
              <input type="hidden" id="admin-id">
              <div>
                <label for="admin-email" class="block text-sm font-medium text-gray-700 text-left mb-1">Email address</label>
                <input type="email" name="email" id="admin-email" autocomplete="email" 
                       class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                       placeholder="user@example.com">
                <p class="mt-1 text-sm text-red-600 hidden" id="email-error">Please enter a valid email address</p>
              </div>
              
              <div>
                <label for="admin-role" class="block text-sm font-medium text-gray-700 text-left mb-1">Role</label>
                <select id="admin-role" name="role" class="mt-1 block w-full rounded-md border-gray-300 py-2 pl-3 pr-10 text-base focus:border-blue-500 focus:outline-none focus:ring-blue-500 sm:text-sm">
                  <option value="Super Admin">Super Admin</option>
                  <option value="Content Manager">Content Manager</option>
                  <option value="Support">Support</option>
                  <option value="Custom">Custom</option>
                </select>
              </div>
              
              <fieldset class="mt-4">
                <legend class="text-sm font-medium text-gray-700 mb-2">Permissions</legend>
                <div class="space-y-2">
                  <div class="relative flex items-start">
                    <div class="flex h-5 items-center">
                      <input id="perm-users" name="permissions" type="checkbox" value="users" checked
                             class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    </div>
                    <div class="ml-3 text-sm">
                      <label for="perm-users" class="font-medium text-gray-700">Manage Users</label>
                      <p class="text-gray-500">View, add, edit, and delete users</p>
                    </div>
                  </div>
                  
                  <div class="relative flex items-start">
                    <div class="flex h-5 items-center">
                      <input id="perm-content" name="permissions" type="checkbox" value="content" checked
                             class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    </div>
                    <div class="ml-3 text-sm">
                      <label for="perm-content" class="font-medium text-gray-700">Manage Content</label>
                      <p class="text-gray-500">Create, edit, and delete platform content</p>
                    </div>
                  </div>
                  
                  <div class="relative flex items-start">
                    <div class="flex h-5 items-center">
                      <input id="perm-analytics" name="permissions" type="checkbox" value="analytics" checked
                             class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    </div>
                    <div class="ml-3 text-sm">
                      <label for="perm-analytics" class="font-medium text-gray-700">View Analytics</label>
                      <p class="text-gray-500">Access to platform analytics and reports</p>
                    </div>
                  </div>
                  
                  <div class="relative flex items-start">
                    <div class="flex h-5 items-center">
                      <input id="perm-settings" name="permissions" type="checkbox" value="settings"
                             class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    </div>
                    <div class="ml-3 text-sm">
                      <label for="perm-settings" class="font-medium text-gray-700">System Settings</label>
                      <p class="text-gray-500">Modify system configuration and settings</p>
                    </div>
                  </div>
                </div>
              </fieldset>
            </div>
          </div>
        </div>
        <div class="mt-5 sm:mt-6 sm:grid sm:grid-flow-row-dense sm:grid-cols-2 sm:gap-3">
          <button type="button" id="saveAdminBtn"
                  class="inline-flex w-full justify-center rounded-md border border-transparent bg-blue-600 px-4 py-2 text-base font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 sm:col-start-2 sm:text-sm">
            Add Admin
          </button>
          <button type="button" id="cancelBtn"
                  class="mt-3 inline-flex w-full justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-base font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 sm:col-start-1 sm:mt-0 sm:text-sm">
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Enhanced Delete Confirmation Modal -->
  <div id="deleteModal" class="fixed z-50 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
      <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
      <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
      <div class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6">
        <div class="sm:flex sm:items-start">
          <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
            <i class="bi bi-exclamation-triangle text-red-600"></i>
          </div>
          <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
              <span id="delete-modal-title">Remove Admin Privileges</span>
            </h3>
            <div class="mt-2">
              <p class="text-sm text-gray-600">
                You are about to remove admin privileges from <span id="admin-email-display" class="font-medium"></span>.
                This will revoke their access to the admin dashboard and all administrative functions.
              </p>
              <div id="delete-consequences" class="mt-3 p-3 bg-red-50 rounded-md text-sm text-red-700">
                <p class="font-medium">This action cannot be undone.</p>
                <ul class="list-disc pl-5 mt-1 space-y-1">
                  <li>User will lose all admin permissions immediately</li>
                  <li>Any pending admin actions will be cancelled</li>
                  <li>User will be logged out of all admin sessions</li>
                </ul>
              </div>
              <div id="last-admin-warning" class="hidden mt-3 p-3 bg-yellow-50 rounded-md text-sm text-yellow-700">
                <p class="font-medium">Warning: This is the last admin account</p>
                <p class="mt-1">Removing this admin will leave the system without any administrators. Please ensure another admin account is available before proceeding.</p>
              </div>
            </div>
          </div>
        </div>
        <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
          <button type="button" id="confirmDeleteBtn" 
                  class="w-full inline-flex justify-center items-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm transition-colors duration-150">
            <span id="delete-btn-text">Remove Admin</span>
            <span id="delete-loading" class="hidden ml-2">
              <i class="bi bi-arrow-repeat animate-spin"></i>
            </span>
          </button>
          <button type="button" id="cancelDeleteBtn" 
                  class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:w-auto sm:text-sm transition-colors duration-150">
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // DOM Elements
    const addAdminBtn = document.getElementById('addAdminBtn');
    const adminModal = document.getElementById('adminModal');
    const deleteModal = document.getElementById('deleteModal');
    const cancelBtn = document.getElementById('cancelBtn');
    const saveAdminBtn = document.getElementById('saveAdminBtn');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
    const adminEmailInput = document.getElementById('admin-email');
    const adminRoleSelect = document.getElementById('admin-role');
    let currentAdminId = null;
    
    // CSRF Token for form submissions
    const csrfToken = document.cookie.split('; ').find(row => row.startsWith('csrf_token='))?.split('=')[1];
    
    // Get current user ID from session
    const currentUserId = '{{ session.user.id if session.user else "" }}';
    
    // API Base URL
    const API_BASE_URL = '/api/admin';
    
    // Headers for API requests
    const headers = {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrfToken,
      'Authorization': `Bearer ${localStorage.getItem('sb-access-token') || ''}`
    };

    // API Functions
    async function fetchAdmins(page = 1, perPage = 10, search = '') {
      try {
        const url = new URL(`${API_BASE_URL}/admins`);
        url.searchParams.append('page', page);
        url.searchParams.append('per_page', perPage);
        if (search) {
          url.searchParams.append('search', search);
        }
        
        const response = await fetch(url, { headers });
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || 'Failed to fetch admins');
        }
        
        return data;
      } catch (error) {
        console.error('Error fetching admins:', error);
        showError(error.message || 'Failed to load admin list');
        return { data: [], pagination: { total: 0 } };
      }
    }
    
    async function createAdmin(adminData) {
      try {
        const response = await fetch(`${API_BASE_URL}/admins`, {
          method: 'POST',
          headers,
          body: JSON.stringify(adminData)
        });
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || 'Failed to create admin');
        }
        
        return data;
      } catch (error) {
        console.error('Error creating admin:', error);
        throw error;
      }
    }
    
    async function updateAdmin(adminId, adminData) {
      try {
        const response = await fetch(`${API_BASE_URL}/admins/${adminId}`, {
          method: 'PUT',
          headers,
          body: JSON.stringify(adminData)
        });
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || 'Failed to update admin');
        }
        
        return data;
      } catch (error) {
        console.error('Error updating admin:', error);
        throw error;
      }
    }
    
    async function deleteAdmin(adminId) {
      try {
        const response = await fetch(`${API_BASE_URL}/admins/${adminId}`, {
          method: 'DELETE',
          headers
        });
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || 'Failed to delete admin');
        }
        
        return data;
      } catch (error) {
        console.error('Error deleting admin:', error);
        throw error;
      }
    }
    
    // DOM Event Handlers
    addAdminBtn.addEventListener('click', function() {
      document.getElementById('modal-title').textContent = 'Add New Admin';
      document.getElementById('saveAdminBtn').textContent = 'Add Admin';
      document.getElementById('admin-id').value = '';
      document.getElementById('admin-email').value = '';
      document.getElementById('admin-role').value = 'Content Manager';
      resetPermissions();
      adminModal.classList.remove('hidden');
    });

    // Open Edit Admin Modal
    window.openEditModal = function(id, email, role, permissions) {
      currentAdminId = id;
      document.getElementById('modal-title').textContent = 'Edit Admin';
      document.getElementById('saveAdminBtn').textContent = 'Update Admin';
      document.getElementById('admin-id').value = id;
      document.getElementById('admin-email').value = email;
      document.getElementById('admin-role').value = role || 'Content Manager';
      
      // Set permissions checkboxes
      if (permissions && Array.isArray(permissions)) {
        document.querySelectorAll('input[name="permissions"]').forEach(checkbox => {
          checkbox.checked = permissions.includes(checkbox.value);
        });
      } else {
        // If no permissions provided, uncheck all
        document.querySelectorAll('input[name="permissions"]').forEach(checkbox => {
          checkbox.checked = false;
        });
      }
      
      adminModal.classList.remove('hidden');
    };

    // Reset permission checkboxes
    function resetPermissions() {
      document.querySelectorAll('input[name="permissions"]').forEach(checkbox => {
        checkbox.checked = false;
      });
      // Default permissions
      ['users', 'content', 'analytics'].forEach(perm => {
        const checkbox = document.querySelector(`input[name="permissions"][value="${perm}"]`);
        if (checkbox) checkbox.checked = true;
      });
    }

    // Handle role change
    document.getElementById('admin-role').addEventListener('change', function() {
      const role = this.value;
      const permissions = {
        'Super Admin': ['users', 'content', 'analytics', 'settings'],
        'Content Manager': ['content', 'analytics'],
        'Support': ['users', 'analytics'],
        'Custom': []
      };
      
      if (role !== 'Custom') {
        resetPermissions();
        if (permissions[role]) {
          permissions[role].forEach(perm => {
            const checkbox = document.querySelector(`input[name="permissions"][value="${perm}"]`);
            if (checkbox) checkbox.checked = true;
          });
        }
      }
    });

    // Save Admin
    saveAdminBtn.addEventListener('click', async function() {
      const email = document.getElementById('admin-email').value.trim();
      const role = document.getElementById('admin-role').value;
      const permissions = Array.from(document.querySelectorAll('input[name="permissions"]:checked')).map(cb => cb.value);
      const adminId = document.getElementById('admin-id').value;
      
      // Basic validation
      if (!email) {
        showError('Email is required');
        return;
      }
      
      if (!isValidEmail(email)) {
        showError('Please enter a valid email address');
        return;
      }
      
      if (permissions.length === 0) {
        showError('Please select at least one permission');
        return;
      }
      
      // Prepare data
      const adminData = {
        email: email,
        role: role,
        permissions: permissions
      };
      
      // Show loading state
      const saveBtnText = saveAdminBtn.innerHTML;
      saveAdminBtn.disabled = true;
      saveAdminBtn.innerHTML = '<i class="animate-spin bi bi-arrow-repeat"></i> Saving...';
      
      try {
        if (adminId) {
          // Update existing admin
          await updateAdmin(adminId, adminData);
          showSuccess('Admin updated successfully');
        } else {
          // Create new admin
          await createAdmin(adminData);
          showSuccess('Admin added successfully');
        }
        
        // Close modal and refresh the admin list
        adminModal.classList.add('hidden');
        loadAdmins();
        
      } catch (error) {
        console.error('Error saving admin:', error);
        showError(error.message || 'Failed to save admin');
      } finally {
        // Reset button state
        saveAdminBtn.disabled = false;
        saveAdminBtn.innerHTML = saveBtnText;
      }
    });
    
    // Show error message with more details
    function showError(message, error = null) {
      console.error('Error:', message, error);
      const errorDiv = document.getElementById('error-message');
      
      // Create a more detailed error message
      let errorMessage = message;
      if (error) {
        if (error.response) {
          // The request was made and the server responded with a status code
          // that falls out of the range of 2xx
          errorMessage = `Error ${error.response.status}: `;
          if (error.response.data && error.response.data.error) {
            errorMessage += error.response.data.error;
          } else {
            errorMessage += message;
          }
        } else if (error.request) {
          // The request was made but no response was received
          errorMessage = 'No response from server. Please check your connection.';
        } else {
          // Something happened in setting up the request that triggered an Error
          errorMessage = `Error: ${error.message}`;
        }
      }
      
      // Update the error message and show it
      errorDiv.innerHTML = `
        <div class="flex items-center">
          <i class="bi bi-exclamation-circle text-red-500 mr-2"></i>
          <span>${errorMessage}</span>
        </div>
        ${error ? `<div class="mt-1 text-xs text-red-700">${error.message || ''}</div>` : ''}
      `;
      
      errorDiv.classList.remove('hidden');
      // Scroll to the error message
      errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
      
      // Hide after 8 seconds
      setTimeout(() => {
        errorDiv.classList.add('opacity-0');
        setTimeout(() => errorDiv.classList.add('hidden'), 300);
      }, 8000);
      
      // Re-enable any disabled buttons
      document.querySelectorAll('button[disabled]').forEach(btn => {
        if (!btn.classList.contains('keep-disabled')) {
          btn.disabled = false;
        }
      });
    }
    
    // Show success message with optional details
    function showSuccess(message, details = '') {
      console.log('Success:', message, details);
      const successDiv = document.getElementById('success-message');
      
      // Update the success message and show it
      successDiv.innerHTML = `
        <div class="flex items-center">
          <i class="bi bi-check-circle text-green-500 mr-2"></i>
          <span>${message}</span>
        </div>
        ${details ? `<div class="mt-1 text-xs text-green-700">${details}</div>` : ''}
      `;
      
      successDiv.classList.remove('hidden');
      // Scroll to the success message
      successDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
      
      // Hide after 5 seconds with fade out
      setTimeout(() => {
        successDiv.classList.add('opacity-0');
        setTimeout(() => successDiv.classList.add('hidden'), 300);
      }, 5000);
      
      // Re-enable any disabled buttons
      document.querySelectorAll('button[disabled]').forEach(btn => {
        if (!btn.classList.contains('keep-disabled')) {
          btn.disabled = false;
        }
      });
      
      // Remove loading states
      document.querySelectorAll('.loading-spinner').forEach(el => {
        el.classList.add('hidden');
      });
      
      // Reset form if in a modal
      const activeModal = document.querySelector('.modal:not(.hidden)');
      if (activeModal && activeModal.id === 'adminModal') {
        document.getElementById('admin-form').reset();
      }
    }
    
    // Show loading state for a button
    function setLoading(button, isLoading, text = 'Processing...') {
      if (isLoading) {
        button.dataset.originalText = button.innerHTML;
        button.innerHTML = `
          <span class="flex items-center justify-center">
            <i class="bi bi-arrow-repeat animate-spin mr-2"></i>
            ${text}
          </span>
        `;
        button.disabled = true;
      } else {
        if (button.dataset.originalText) {
          button.innerHTML = button.dataset.originalText;
          delete button.dataset.originalText;
        }
        button.disabled = false;
      }
    }
    
    // Email validation
    function isValidEmail(email) {
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(email);
    }
    
    // Load and display admins
    async function loadAdmins(page = 1, search = '') {
      try {
        const perPage = 10;
        const { data, pagination } = await fetchAdmins(page, perPage, search);
        
        // Update the table body
        const tbody = document.querySelector('#adminTable tbody');
        tbody.innerHTML = '';
        
        if (data.length === 0) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td colspan="7" class="py-4 text-center text-gray-500">
              No admins found
            </td>
          `;
          tbody.appendChild(tr);
          return;
        }
        
        data.forEach(admin => {
          const tr = document.createElement('tr');
          tr.className = 'border-b border-gray-200 hover:bg-gray-50';
          
          // Format last login
          const lastLogin = admin.last_sign_in_at 
            ? new Date(admin.last_sign_in_at).toLocaleString()
            : 'Never';
            
          // Format status
          const isActive = admin.is_active !== false; // Default to true if not set
          const statusClass = isActive ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800';
          const statusText = isActive ? 'Active' : 'Inactive';
          
          // Format role
          const roleClass = {
            'admin': 'bg-blue-100 text-blue-800',
            'super_admin': 'bg-purple-100 text-purple-800',
            'content_manager': 'bg-green-100 text-green-800',
            'support': 'bg-yellow-100 text-yellow-800'
          }[admin.role] || 'bg-gray-100 text-gray-800';
          
          tr.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <div class="flex-shrink-0 h-10 w-10">
                  <div class="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center">
                    <i class="bi bi-person text-blue-600 text-lg"></i>
                  </div>
                </div>
                <div class="ml-4">
                  <div class="text-sm font-medium text-gray-900">${admin.email}</div>
                  ${admin.id === currentUserId ? '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">You</span>' : ''}
                </div>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${roleClass}">
                ${admin.role.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                ${statusText}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              ${lastLogin}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              ${(admin.permissions || []).map(p => 
                `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800 mr-1">
                  ${p.replace('_', ' ')}
                </span>`
              ).join('')}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
              ${admin.id !== currentUserId ? `
                <button onclick="openEditModal('${admin.id}', '${admin.email.replace("'", "\\'")}', '${admin.role}', ${JSON.stringify(admin.permissions || [])})" 
                        class="text-indigo-600 hover:text-indigo-900 mr-3">
                  <i class="bi bi-pencil-square"></i> Edit
                </button>
                <button onclick="confirmDelete('${admin.id}', '${admin.email.replace("'", "\\'")}')" 
                        class="text-red-600 hover:text-red-900">
                  <i class="bi bi-trash"></i> Delete
                </button>
              ` : ''}
            </td>
          `;
          
          tbody.appendChild(tr);
        });
        
        // Update pagination
        updatePagination(pagination, page, search);
        
      } catch (error) {
        console.error('Error loading admins:', error);
        showError('Failed to load admin list');
      }
    }
    
    // Update pagination controls
    function updatePagination(pagination, currentPage, search = '') {
      const paginationEl = document.getElementById('pagination');
      if (!pagination || !pagination.total_pages) {
        paginationEl.innerHTML = '';
        return;
      }
      
      const totalPages = pagination.total_pages;
      let paginationHtml = '<nav class="flex items-center justify-between border-t border-gray-200 px-4 sm:px-0">';
      
      // Previous button
      const prevDisabled = currentPage <= 1 ? 'opacity-50 cursor-not-allowed' : '';
      paginationHtml += `
        <div class="-mt-px w-0 flex-1 flex">
          <button onclick="${prevDisabled ? '' : `loadAdmins(${currentPage - 1}, '${search}')`}" 
                  class="border-t-2 border-transparent pt-4 pr-1 inline-flex items-center text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 ${prevDisabled}">
            <i class="bi bi-arrow-left mr-3"></i> Previous
          </button>
        </div>
      `;
      
      // Page numbers
      paginationHtml += '<div class="hidden md:-mt-px md:flex">';
      
      const maxPagesToShow = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
      let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);
      
      if (endPage - startPage + 1 < maxPagesToShow) {
        startPage = Math.max(1, endPage - maxPagesToShow + 1);
      }
      
      if (startPage > 1) {
        paginationHtml += `
          <button onclick="loadAdmins(1, '${search}')" 
                  class="border-t-2 border-transparent pt-4 px-4 inline-flex items-center text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300">
            1
          </button>
          ${startPage > 2 ? '<span class="border-transparent text-gray-500 border-t-2 pt-4 px-4 inline-flex items-center text-sm font-medium">...</span>' : ''}
        `;
      }
      
      for (let i = startPage; i <= endPage; i++) {
        const activeClass = i === currentPage 
          ? 'border-indigo-500 text-indigo-600' 
          : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300';
        
        paginationHtml += `
          <button onclick="loadAdmins(${i}, '${search}')" 
                  class="${activeClass} border-t-2 pt-4 px-4 inline-flex items-center text-sm font-medium">
            ${i}
          </button>
        `;
      }
      
      if (endPage < totalPages) {
        paginationHtml += `
          ${endPage < totalPages - 1 ? '<span class="border-transparent text-gray-500 border-t-2 pt-4 px-4 inline-flex items-center text-sm font-medium">...</span>' : ''}
          <button onclick="loadAdmins(${totalPages}, '${search}')" 
                  class="border-t-2 border-transparent pt-4 px-4 inline-flex items-center text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300">
            ${totalPages}
          </button>
        `;
      }
      
      paginationHtml += '</div>';
      
      // Next button
      const nextDisabled = currentPage >= totalPages ? 'opacity-50 cursor-not-allowed' : '';
      paginationHtml += `
        <div class="-mt-px w-0 flex-1 flex justify-end">
          <button onclick="${nextDisabled ? '' : `loadAdmins(${currentPage + 1}, '${search}')`}" 
                  class="border-t-2 border-transparent pt-4 pl-1 inline-flex items-center text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 ${nextDisabled}">
            Next <i class="bi bi-arrow-right ml-3"></i>
          </button>
        </div>
      `;
      
      paginationHtml += '</nav>';
      paginationEl.innerHTML = paginationHtml;
    }
    
    // Search functionality
    let searchTimeout;
    document.getElementById('searchInput').addEventListener('input', function(e) {
      const searchTerm = e.target.value.trim();
      
      // Debounce search to avoid too many requests
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        loadAdmins(1, searchTerm);
      }, 500);
    });
    
    // Delete Confirmation
    window.confirmDelete = async function(id, email) {
      currentAdminId = id;
      const emailDisplay = document.getElementById('admin-email-display');
      const deleteBtn = document.getElementById('confirmDeleteBtn');
      const deleteBtnText = document.getElementById('delete-btn-text');
      const deleteLoading = document.getElementById('delete-loading');
      const lastAdminWarning = document.getElementById('last-admin-warning');
      
      // Update modal content
      emailDisplay.textContent = email;
      
      // Check if this is the last admin
      try {
        const { data: admins } = await fetchAdmins(1, 100);
        const isLastAdmin = admins.length === 1 && admins[0].id === id;
        
        // Show/hide last admin warning
        lastAdminWarning.classList.toggle('hidden', !isLastAdmin);
        
        // Disable delete button if it's the last admin
        if (isLastAdmin) {
          deleteBtn.disabled = true;
          deleteBtn.classList.add('opacity-50', 'cursor-not-allowed');
          deleteBtnText.textContent = 'Cannot remove last admin';
        } else {
          deleteBtn.disabled = false;
          deleteBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          deleteBtnText.textContent = 'Remove Admin';
        }
      } catch (error) {
        console.error('Error checking admin count:', error);
        showError('Unable to verify admin status. Please try again.');
        return;
      }
      
      // Show delete modal
      deleteModal.classList.remove('hidden');
      
      // Set up delete button handler
      const deleteHandler = async () => {
        try {
          // Show loading state
          deleteBtn.disabled = true;
          deleteBtnText.textContent = 'Removing...';
          deleteLoading.classList.remove('hidden');
          
          // Call delete API
          await deleteAdmin(id);
          
          // Show success message and refresh the list
          showSuccess(
            'Admin privileges removed',
            `${email} no longer has administrator access.`
          );
          
          // Close modal and refresh the list
          deleteModal.classList.add('hidden');
          loadAdmins();
          
        } catch (error) {
          console.error('Error deleting admin:', error);
          
          // Show appropriate error message
          if (error.response) {
            if (error.response.status === 403) {
              showError('Permission denied', 'You do not have permission to perform this action.');
            } else if (error.response.status === 400) {
              showError('Invalid request', error.response.data?.error || 'Cannot process this request.');
            } else {
              showError('Server error', 'An error occurred while processing your request. Please try again.');
            }
          } else if (error.request) {
            showError('Connection error', 'Unable to connect to the server. Please check your internet connection.');
          } else {
            showError('Error', error.message || 'An unexpected error occurred.');
          }
          
          // Re-enable the delete button
          deleteBtn.disabled = false;
          deleteBtnText.textContent = 'Try Again';
          deleteLoading.classList.add('hidden');
          
          // Don't remove the event listener so they can try again
          return;
        }
      };
      
      // Remove any existing event listeners
      const newDeleteBtn = deleteBtn.cloneNode(true);
      deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn);
      
      // Add new event listener
      newDeleteBtn.addEventListener('click', deleteHandler, { once: true });
    };
    
    // Initialize the page
    document.addEventListener('DOMContentLoaded', () => {
      loadAdmins();
      
      // Add event delegation for edit buttons
      document.addEventListener('click', function(e) {
        const editBtn = e.target.closest('.edit-admin-btn');
        if (editBtn) {
          const id = editBtn.dataset.adminId;
          const email = editBtn.dataset.email;
          const role = editBtn.dataset.role;
          const permissions = JSON.parse(editBtn.dataset.permissions || '[]');
          openEditModal(id, email, role, permissions);
        }
      });
    });
    
    // Close modals
    function closeModal(modal) {
      modal.classList.add('hidden');
    }
    
    // Event listeners for closing modals
    cancelBtn.addEventListener('click', () => closeModal(adminModal));
    cancelDeleteBtn.addEventListener('click', () => closeModal(deleteModal));
    
    // Close modals when clicking outside
    window.addEventListener('click', (event) => {
      if (event.target === adminModal) closeModal(adminModal);
      if (event.target === deleteModal) closeModal(deleteModal);
    });
    
    // Close modals with Escape key
    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        closeModal(adminModal);
        closeModal(deleteModal);
      }
    });
  });
</script>
{% endblock %}
</body>
</html>
